<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMU Matrix Generator</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: #eee; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #sidebar {
            position: absolute; right: 0; top: 0; bottom: 0; width: 320px;
            background: rgba(0, 0, 0, 0.9); z-index: 10; padding: 20px;
            border-left: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column;
        }
        h1 { font-size: 18px; color: #00ff88; border-bottom: 1px solid #555; padding-bottom: 10px; margin-top:0;}
        h2 { font-size: 14px; color: #aaa; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .control-group { background: #222; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 10px;}
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        label { font-size: 13px; font-weight: bold; }
        select { background: #333; color: #fff; border: 1px solid #555; padding: 4px; }
        button {
            width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px;
            background: #444; color: #fff; font-weight: bold; cursor: pointer;
        }
        button:hover { background: #555; }
        button#btn-connect { background: #0088ff; }
        button#btn-calibrate { background: #00aa66; margin-top: 15px; }
        
        /* CODE OUTPUT STYLES */
        textarea {
            width: 100%; height: 120px; background: #000; color: #00ff00;
            font-family: 'Courier New', monospace; font-size: 11px;
            border: 1px solid #444; resize: none; margin-top: 5px;
            padding: 5px; box-sizing: border-box;
        }
        .copy-hint { font-size: 11px; color: #888; margin-bottom: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="sidebar">
        <h1>IMU Matrix Generator</h1>
        <button id="btn-connect">Connect USB</button>
        <div style="font-size:12px; color:#888; margin-top:5px;" id="status">Disconnected</div>

        <h2>1. Axis Mapping</h2>
        <div class="control-group">
            <div class="row"><label style="color:#ff4444">Pitch (X)</label><select id="map-x"><option value="x">IMU X</option><option value="y">IMU Y</option><option value="z">IMU Z</option></select><input type="checkbox" id="inv-x">Inv</div>
            <div class="row"><label style="color:#44ff44">Yaw (Y)</label><select id="map-y"><option value="x">IMU X</option><option value="y">IMU Y</option><option value="z" selected>IMU Z</option></select><input type="checkbox" id="inv-y">Inv</div>
            <div class="row"><label style="color:#4444ff">Roll (Z)</label><select id="map-z"><option value="x">IMU X</option><option value="y" selected>IMU Y</option><option value="z">IMU Z</option></select><input type="checkbox" id="inv-z" checked>Inv</div>
        </div>

        <h2>2. Zero Calibration</h2>
        <p style="font-size:11px; color:#ccc; margin:0;">Place vehicle in neutral/level position.</p>
        <button id="btn-calibrate" disabled>TARE (Set Zero)</button>

        <h2>3. Get The Code</h2>
        <div class="copy-hint">Copy this into your ESP32 script:</div>
        <textarea id="code-output" readonly>// Connect and Calibrate to generate code...</textarea>
    </div>

    <script>
        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(2.5, 2.5, 3.5); camera.lookAt(0,0,0);
        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(5,10,7); scene.add(dl);
        scene.add(new THREE.GridHelper(10, 10, 0x444444, 0x222222));
        scene.add(new THREE.AxesHelper(1)); // World Origin

        // Object Hierarchy
        const wrapper = new THREE.Group();
        scene.add(wrapper);
        const box = new THREE.Mesh(new THREE.BoxGeometry(2, 0.4, 3), new THREE.MeshNormalMaterial());
        box.add(new THREE.AxesHelper(2)); // Local Axes
        wrapper.add(box);

        // --- VARS ---
        let port, reader;
        let imuData = {w:1, x:0, y:0, z:0};
        let buffer = "";
        const targetQuat = new THREE.Quaternion();
        const correctionQuat = new THREE.Quaternion(); // Identity by default

        // --- LOGIC ---
        const getMap = () => ({
            x: { src: document.getElementById('map-x').value, inv: document.getElementById('inv-x').checked ? -1:1 },
            y: { src: document.getElementById('map-y').value, inv: document.getElementById('inv-y').checked ? -1:1 },
            z: { src: document.getElementById('map-z').value, inv: document.getElementById('inv-z').checked ? -1:1 },
        });

        document.getElementById('btn-connect').onclick = async () => {
            if(navigator.serial) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({baudRate: 115200});
                    document.getElementById('status').innerText = "Connected";
                    document.getElementById('status').style.color = "#00ff00";
                    document.getElementById('btn-connect').style.display = 'none';
                    document.getElementById('btn-calibrate').disabled = false;
                    readLoop();
                } catch(e) { alert(e); }
            }
        };

        async function readLoop() {
            const dec = new TextDecoderStream();
            port.readable.pipeTo(dec.writable);
            const r = dec.readable.getReader();
            while(true) {
                const {value, done} = await r.read();
                if(done) break;
                if(value) {
                    buffer += value;
                    let lines = buffer.split('\n');
                    buffer = lines.pop();
                    for(let l of lines) if(l.trim()) parse(l);
                }
            }
        }

        function parse(line) {
            try {
                const d = JSON.parse(line);
                if(d.type==="imu" && d.quat) {
                    imuData = {w:d.quat[0], x:d.quat[1], y:d.quat[2], z:d.quat[3]};
                    updateBox();
                }
            } catch(e){}
        }

        function updateBox() {
            const m = getMap();
            const raw = {x:imuData.x, y:imuData.y, z:imuData.z};
            // Apply Mapping
            targetQuat.set(
                raw[m.x.src] * m.x.inv,
                raw[m.y.src] * m.y.inv,
                raw[m.z.src] * m.z.inv,
                imuData.w
            ).normalize();
        }

        function animate() {
            requestAnimationFrame(animate);
            box.quaternion.slerp(targetQuat, 0.2);
            renderer.render(scene, camera);
        }
        animate();
        window.onresize = () => { camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); };

        // --- CALIBRATION GENERATOR ---
        document.getElementById('btn-calibrate').onclick = () => {
            // 1. Calculate the inverse of the CURRENT box rotation
            // This is the rotation needed to bring the box back to identity (flat)
            correctionQuat.copy(box.quaternion).invert();
            
            // Apply immediately to wrapper to show user it worked
            wrapper.quaternion.copy(correctionQuat);

            // 2. Generate C++ Code
            const w = correctionQuat.w.toFixed(6);
            const x = correctionQuat.x.toFixed(6);
            const y = correctionQuat.y.toFixed(6);
            const z = correctionQuat.z.toFixed(6);

            const code = 
`// PASTE IN GLOBAL VARIABLES
float tareQuat[4] = {${w}, ${x}, ${y}, ${z}};

// USE THIS FUNCTION TO CORRECT DATA
void applyCalibration(float &w, float &x, float &y, float &z) {
    // Quaternion Multiplication: Tare * Raw
    float nw = tareQuat[0]*w - tareQuat[1]*x - tareQuat[2]*y - tareQuat[3]*z;
    float nx = tareQuat[0]*x + tareQuat[1]*w + tareQuat[2]*z - tareQuat[3]*y;
    float ny = tareQuat[0]*y - tareQuat[1]*z + tareQuat[2]*w + tareQuat[3]*x;
    float nz = tareQuat[0]*z + tareQuat[1]*y - tareQuat[2]*x + tareQuat[3]*w;
    
    w = nw; x = nx; y = ny; z = nz;
}`;
            document.getElementById('code-output').value = code;
        };
    </script>
</body>
</html>